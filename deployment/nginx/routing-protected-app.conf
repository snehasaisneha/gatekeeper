# =============================================================================
# Routing: Protected App (runs on Routing server)
# =============================================================================
# Public endpoint for docs.example.com → auth_request to Gatekeeper, then
# proxies to App server. Template - copy for each protected app.
# No HTTPS - run certbot after nginx -t passes.
# =============================================================================

# App slug (must match Gatekeeper registration)
set $app_slug "docs";  # EDIT

# Gatekeeper server (for auth validation)
set $gatekeeper_server "10.0.0.10:8000";  # EDIT

# App server
set $app_server "10.0.0.20:3000";  # EDIT

# Gatekeeper public URL (for redirects)
set $gatekeeper_url "http://auth.example.com";  # EDIT (https after certbot)

server {
    listen 80;
    server_name docs.example.com;  # EDIT: Your app domain

    # Auth validation (internal)
    location = /_gk/validate {
        internal;
        proxy_pass http://$gatekeeper_server/api/v1/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-GK-App $app_slug;
        proxy_set_header Cookie $http_cookie;
    }

    # All requests → auth then proxy
    location / {
        auth_request /_gk/validate;

        # Get user info from auth response
        auth_request_set $auth_user $upstream_http_x_auth_user;

        # Forward to app
        proxy_set_header X-Auth-User $auth_user;
        proxy_pass http://$app_server;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Auth failures
        error_page 401 = @login;
        error_page 403 = @denied;
    }

    # 401 → redirect to login
    location @login {
        return 302 $gatekeeper_url/signin?redirect=$scheme://$host$request_uri;
    }

    # 403 → access denied
    location @denied {
        return 302 $gatekeeper_url/request-access?app=$app_slug;
    }
}
